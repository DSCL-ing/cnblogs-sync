[toc]



# AVL树

## AVL树的概念 

> 二叉搜索树虽可以缩短查找的效率，但如果**数据有序或接近有序二叉搜索树将退化为单支树**，查找元素相当于在顺序表中搜索元素，效率低下。因此，两位俄罗斯的数学家G.M.**A**delson-**V**elskii和E.M.**L**andis在1962年发明了一种解决上述问题的方法：当向二叉搜索树中插入新结点后，如果能保证每个结点的左右子树高度之差的绝对值不超过1(需要对树中的结点进行调整)，即可降低树的高度，从而减少平均搜索长度。
> 一棵AVL树或者是空树，或者是具有以下性质的二叉搜索树：
>
> - 它的左右子树都是AVL树 
>
> - 左右子树高度之差(简称平衡因子)的绝对值不超过1(-1/0/1)
>
>   ![image-20240821125504112](STL%20%E5%B9%B3%E8%A1%A1%E6%90%9C%E7%B4%A2%E6%A0%91-AVL%E6%A0%91%20C++%E5%AE%9E%E7%8E%B0.assets/image-20240821125504112.png)
>
>   (默认平衡因子=右子树高度-左子树高度)
>
> **如果一棵二叉搜索树是高度平衡的，它就是AVL树。**如果它有n个结点，其高度可保持在$O(log_2 n)$，搜索时间复杂度O($log_2 n$)。



AVL树是由BST二叉搜索树改进而来,基本概念参考BST篇,本篇文章不再详细描述.



### AVL树节点的定义：

```
template<class K, class V> 
struct AVLTreeNode
{
		//三叉链: left right parent
     AVLTreeNode* _left;   // 该节点的左孩子 
     AVLTreeNode* _right;  // 该节点的右孩子 
     AVLTreeNode* _parent; // 该节点的双亲
     std::pair<K,V> _kv;	 // 键值对
     int _bf;              // 该节点的平衡因子 balance factor

		AVLTreeNode(const std::pair<K, V>& kv)
			:_left(nullptr)
			, _right(nullptr)
			, _parent(nullptr)
			, _kv(kv)
			, _bf(0)
		{}
};
```



### AVL树的插入



#### 基本情况分析

AVL树就是在二叉搜索树的基础上引入了平衡因子，因此AVL树也可以看成是二叉搜索树。那么AVL树的插入过程可以分为两步：
1. 按照二叉搜索树的方式插入新节点

2. 调整节点的平衡因子

   a. 更新父结点平衡因子

   b. 根据父结点的平衡因子进行相应的操作



对于平衡因子

插入新结点后,首先可能会**影响父结点的平衡因子**,迭代往上,可能还会影响部分或全部(到根节点)祖先结点的平衡因子.

具体地说,即插入新结点后,需要根据父结点平衡因子的情况,决定是否继续往上对祖结点进行更新平衡因子,最多到达根结点.



#### 平衡因子对应的操作

父结点平衡因子如何决定是否继续往上更新? 取决于更新后parent->_bf的值

1. 若`parent->_bf == 1 || parent->_bf == -1` ,说明插入前的父结点一定是左右子树高度相等,即\_bf为0.新增结点后父结点所在子树高度一定发生变化,爷爷结点所在子树也可能发生变化,因此需要进行**迭代更新祖先平衡因子**.

   > 不可能是2或-2变成1或-1,因为这是AVL树的插入,至少先保证是AVL树才能插入

   ![image-20240821143019855](STL%20%E5%B9%B3%E8%A1%A1%E6%90%9C%E7%B4%A2%E6%A0%91-AVL%E6%A0%91%20C++%E5%AE%9E%E7%8E%B0.assets/image-20240821143019855.png)

2. 若`parent->_bf == 2 || parent->_bf == -2` ,说明插入前的父结点所在子树一边高一边低,之后新结点恰好插入到了高的一边,导致不平衡,需要**做旋转操作,调整平衡**.

3. `parent->_bf == 0`,插入后父结点的平衡因子平衡,说明原先父结点的左右子树是一边高一边低,然后插入刚好插到了低的一边,使其平衡.**插入结束**.



#### 旋转操作